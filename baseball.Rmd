---
title: 'STAT 139: Final Project'
author: "Danny Kim, Christopher Lee, Karina Wang, Daniel Son"
date: "2022-12-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## EDA
```{r}
library(dplyr)
# Load team data
team_data = list()
team_wins <- list()
drop = c("W", "L")
for (year in 1997:2022) {
  df1 = read.csv(paste("data/teams_data/batting", year, ".csv", sep=""))
  df2 = read.csv(paste("data/teams_data/pitching", year, ".csv", sep=""))
  df_tot = merge(df1, df2, by="Tm", suffixes=c(".bat", ".pitch"))
  
  df_tot = df_tot[
    !(df_tot$Tm %in% c("", "League Average")),
    !(names(df_tot) %in% drop)
  ]
  df_tot$Tm = factor(df_tot$Tm)
  team_data[[year]] = df_tot
  team_wins[[year]] = df_tot[, c("Tm", "W.L.")]
}

# Load player data
years <- 1997:2022
bps <- c("batting", "pitching")
player_data <- list()
for (year in years) {
  player_data[[year]] <- list()
  for (bp in bps) {
    player_data[[year]][[bp]] <- read.csv(paste("data/player_data/", bp, year, ".csv", sep=""))
    quant_cols <- names(select_if(player_data[[year]][[bp]], is.numeric))
    for (col in quant_cols) {
      # impute data with mean
      df <- player_data[[year]][[bp]]
      player_data[[year]][[bp]][is.na(player_data[[year]][[bp]][,col]),col] <- mean(df[,col], na.rm=TRUE)
    }
  }
}
```

```{r}
# Data Cleaning for the Team Data
team_wins <- list()
for (year in years) {
  team_wins[[year]] <- team_data[[year]][!(team_data[[year]]$Tm %in% c("", "League Average")),c("Tm", "W.L.")]
}
```

```{r}

# Clean player data
for (year in years) {
  for (bp in bps) {
    player_data[[year]][[bp]]$year <- year
  }
}

for (year in years) {
  player_data[[year]][["pitching"]] = player_data[[year]][["pitching"]][!is.infinite(player_data[[year]][["pitching"]]$ERA),]
}

long_team_names <- team_data[[year]][!(team_data[[year]]$Tm %in% c("", "League Average")),]$Tm
short_team_names <- c("ARI", "ATL", "BAL", "BOS", "CHC", "CHW", "CIN", "CLE", "COL", "DET",
                      "HOU", "KCR", "LAA", "LAD", "MIA", "MIL", "MIN", "NYM", "NYY", "OAK",
                      "PHI", "PIT", "SDP", "SFG", "SEA", "STL", "TBR", "TEX", "TOR", "WSN")
agg_data <- list()
for (year in years) {
  agg_data[[year]] <- list()
  for (bp in bps) {
    quant_cols <- names(select_if(player_data[[year]][[bp]], is.numeric))
    agg_data[[year]][[bp]] <- player_data[[year]][[bp]][, c("Tm", quant_cols)] %>% 
      group_by(Tm) %>%
      summarise(across(quant_cols, ~weighted.mean(., w = G)))
    agg_data[[year]][[bp]] <- agg_data[[year]][[bp]][!(agg_data[[year]][[bp]]$Tm == "TOT"),]
    agg_data[[year]][[bp]]$long_Tm <- factor(
      agg_data[[year]][[bp]]$Tm,
      levels=short_team_names,
      labels=long_team_names
    )
  }
}

player_combo <- list()
for (year in years) {
  player_combo[[year]] <- merge(agg_data[[year]][[bps[1]]], agg_data[[year]][[bps[2]]], by="Tm", suffixes=c(".bat", ".pitch"))
}

# add response variable to player data
player_with_wins <- list()
for (year in 1997:2021) {
  player_with_wins[[year]] <- merge(player_combo[[year]], team_wins[[year+1]], by.x="long_Tm.pitch", by.y="Tm", suffixes=c(".same_year", ".next_year"))
}
player_with_wins_combined = bind_rows(player_with_wins, )
player_with_wins_combined$W.L..same_year = 100 * player_with_wins_combined$W.L..same_year
player_with_wins_combined$W.L..next_year = 100 * player_with_wins_combined$W.L..next_year
n.rows = nrow(player_with_wins_combined)
n.train = 0.8 * n.rows
train.rows = sample(n.rows, n.train)
train.df = player_with_wins_combined[train.rows,]
colnames(train.df)[colnames(train.df) == 'OPS.'] <- 'OPSplus'
colnames(train.df)[colnames(train.df) == 'ERA.'] <- 'ERAplus'
test.df = player_with_wins_combined[-train.rows,]
colnames(test.df)[colnames(test.df) == 'OPS.'] <- 'OPSplus'
colnames(test.df)[colnames(test.df) == 'ERA.'] <- 'ERAplus'
```

```{r}
train.df
names(train.df)
```


```{r}
# Explore Potential Predictors
par(mfrow=c(3,3))
plot(W.L..next_year ~ Age.bat, data=train.df,
     xlab="Batters' Average Age", ylab="Winning Percentage")
plot(W.L..next_year ~ Age.pitch, data=train.df,
     xlab="Pitchers' Average Age", ylab="Winning Percentage")
plot(W.L..next_year ~ BA, data=train.df,
     xlab="Batting Average", ylab="Winning Percentage")
plot(W.L..next_year ~ HR.bat, data=train.df,
     xlab="Average Home Runs", ylab="Winning Percentage")
plot(W.L..next_year ~ OPSplus, data=train.df,
     xlab="Adjusted On Base Percentage Plus Slugging", ylab="Winning Percentage")
plot(W.L..next_year ~ ERAplus, data=train.df,
     xlab="Adjusted Earned Run Average", ylab="Winning Percentage")
plot(W.L..next_year ~ SO.W, data=train.df,
     xlab="Average Strikeout/Walk", ylab="Winning Percentage")
plot(W.L..next_year ~ HR9, data=train.df,
     xlab="Average Home Runs per Nine Innings", ylab="Winning Percentage")
plot(W.L..next_year ~ WHIP, data=train.df,
     xlab="Walks and Hits Per Inning Pitched", ylab="Winning Percentage")
```

```{r}
# Summary statistics for winpct
summary(train.df$W.L..next_year)

# Histogram for winpct
hist(train.df$W.L..next_year, main="Distribution of Winning Percentage",
     xlab="Winning Percentage")
```

```{r}
# Correlation matrix
cor(train.df[, c("W.L..next_year", "Age.bat", "Age.pitch", "BA", "HR.bat", "OPS", "ERAplus", "SO.W", "HR9", "WHIP")])
cor(train.df[, c("W.L..next_year", "Age.bat", "Age.pitch", "BA", "HR.bat", "OPS", "ERAplus", "SO.W", "HR9", "WHIP")])^2
```


```{r}
# Baseline Multiple Regression Model
baseline <- lm(W.L..next_year ~ Age.bat + Age.pitch + BA + HR.bat + 
                 OPS + ERAplus + SO.W + HR9 + WHIP, data = train.df)
summary(baseline)
```


```{r}
# Asssess Linear Model Assumptions
plot(baseline, which=c(1,2))
```

## Linear Regression

```{r}
colnames(train.df)
```

```{r}
# ignore Rk.bat, R.bat, RBI, year.bat, Rk.pitch, W, L, R.pitch
# year.pitch, WL..next_year
lm.full <- lm(W.L..next_year ~ Age.bat + G.bat + PA + AB + H.bat + X2B + X3B + 
                HR.bat + SB + CS + BB.bat + SO.bat + BA + OBP + SLG + OPS + OPSplus +
                TB + GDP + HBP.bat + SH + SF + IBB.bat + Age.pitch + W.L..same_year + 
                ERA + G.pitch + GS + GF + CG + SHO + SV + IP + H.pitch + ER + 
                HR.pitch + BB.pitch + IBB.pitch + SO.pitch + HBP.pitch + BK + WP + 
                BF + ERAplus + FIP + WHIP + H9 + HR9 + BB9 + SO9 + SO.W, data = train.df)
```

## Decision Tree/Random Forest
```{r}
set.seed(139)
library(rpart)

RMSE = function(y,yhat){
return(sqrt(mean((y-yhat)^2)))
}

test.df = subset(test.df, test.df$Tm != 'CLE')
tree1 = rpart(W.L..next_year~.,data=train.df, control = list(minsplit=1,cp=0,maxdepth=20))
yhat.tree1.train = predict(tree1)
yhat.tree1.test = predict(tree1, newdata = test.df)
RMSE.tree1.train = RMSE(train.df$W.L..next_year,yhat.tree1.train)
RMSE.tree1.test = RMSE(test.df$W.L..next_year,yhat.tree1.test)
data.frame(train=RMSE.tree1.train,test=RMSE.tree1.test)
```

```{r}
best.cp = tree1$cptable[,"CP"][which.min(tree1$cptable[,"xerror"])]
tree2 = prune(tree1,best.cp)
yhat.tree2.train = predict(tree2)
yhat.tree2.test = predict(tree2,newdata=test.df)
RMSE.tree2.train = RMSE(train.df$W.L..next_yea,yhat.tree2.train)
RMSE.tree2.test = RMSE(test.df$W.L..next_year,yhat.tree2.test)
data.frame(train=RMSE.tree2.train,test=RMSE.tree2.test)
```

```{r}
library(randomForest)
set.seed(139)
maxnodes1 = maxnodes = c(10,20,50,100)
ntree=200
rmses.rf1 = rep(NA,length(maxnodes))
bestRMSE = sd(train.df$W.L..next_year)
for(i in 1:length(maxnodes)){
  rftemp = randomForest(W.L..next_year~., data=train.df, mtry=1, maxnodes=maxnodes[i], ntree=ntree)
  rmses.rf1[i] = RMSE(train.df$W.L..next_year,rftemp$predicted)
  if(rmses.rf1[i]<bestRMSE){
    best_maxnodes = maxnodes[i]
    bestRMSE=rmses.rf1[i]
    rf1=rftemp
  }
}

data.frame(maxnodes=maxnodes,RMSE=rmses.rf1)
```