---
title: 'STAT 139: Final Project'
author: "Danny Kim, Christopher Lee, Karina Wang, Daniel Son"
date: "2022-12-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## EDA
```{r}
library(dplyr)
library(plyr)
# Load team data
team.batting.2018 <- read.csv('data/team_data/2018batting.csv')
team.pitching.2018 <- read.csv('data/team_data/2018pitching.csv')
team.batting.2019 <- read.csv('data/team_data/2019batting.csv')
team.pitching.2019 <- read.csv('data/team_data/2019pitching.csv')
team.batting.2020 <- read.csv('data/team_data/2020batting.csv')
team.pitching.2020 <- read.csv('data/team_data/2020pitching.csv')
team.batting.2021 <- read.csv('data/team_data/2021batting.csv')
team.pitching.2021 <- read.csv('data/team_data/2021pitching.csv')
team.batting.2022 <- read.csv('data/team_data/2022batting.csv')
team.pitching.2022 <- read.csv('data/team_data/2022pitching.csv')

# Load player data
years <- 2015:2022
bps <- c("batting", "pitching")
player_data <- list()
for (year in years) {
  player_data[[year]] <- list()
  for (bp in bps) {
    player_data[[year]][[bp]] <- read.csv(paste("data/player_data/", bp, year, ".csv", sep=""))
    quant_cols <- names(select_if(player_data[[year]][[bp]], is.numeric))
    for (col in quant_cols) {
      # impute data with mean
      df <- player_data[[year]][[bp]]
      player_data[[year]][[bp]][is.na(player_data[[year]][[bp]][,col]),col] <- mean(df[,col], na.rm=TRUE)
    }
  }
}
```

```{r}
# Data Cleaning for the Team Data
team2018 <- merge(team.pitching.2018, team.batting.2018,by="Tm")
team2019 <- merge(team.pitching.2019, team.batting.2019,by="Tm")
team2020 <- merge(team.pitching.2020, team.batting.2020,by="Tm")
team2021 <- merge(team.pitching.2021, team.batting.2021,by="Tm")
team2022 <- merge(team.pitching.2022, team.batting.2022,by="Tm")

team.list <- rbind(team2018, team2019, team2020, team2021)

# Drop empty and unrelated rows
team.train <- subset(team.list, team.list$Tm != '' & team.list$Tm != 'League Average')
drop <- c("W","L") # Drop wins and losses columns
team.train <- team.train[,!(names(team.train) %in% drop)]
rownames(team.train) <- 1:nrow(team.train)

team.test <- subset(team2022, team2022$Tm != '' & team2022$Tm != 'League Average')
team.test <- team.test[,!(names(team.test) %in% drop)]
rownames(team.test) <- 1:nrow(team.test)
combined <- rbind(team.train, team.test)
rownames(combined) <- 1:nrow(combined)

# Factor teams
team.train$Tm <- factor(team.train$Tm)
team.test$Tm <- factor(team.test$Tm)
combined$Tm <- factor(combined$Tm)

team_data <- list()
team_data[[2018]] <- team2018
team_data[[2019]] <- team2019
team_data[[2020]] <- team2020
team_data[[2021]] <- team2021
team_data[[2022]] <- team2022

team_wins <- list()
for (year in 2018:2022) {
  team_wins[[year]] <- team_data[[year]][!(team_data[[year]]$Tm %in% c("", "League Average")),c("Tm", "W.L.")]
}
```

```{r}

# Clean player data
for (year in years) {
  for (bp in bps) {
    player_data[[year]][[bp]]$year <- year
  }
}
long_team_names <- team_data[[year]][!(team_data[[year]]$Tm %in% c("", "League Average")),]$Tm
short_team_names <- c("ARI", "ATL", "BAL", "BOS", "CHC", "CHW", "CIN", "CLE", "COL", "DET",
                      "HOU", "KCR", "LAA", "LAD", "MIA", "MIL", "MIN", "NYM", "NYY", "OAK",
                      "PHI", "PIT", "SDP", "SFG", "SEA", "STL", "TBR", "TEX", "TOR", "WSN")
agg_data <- list()
for (year in years) {
  agg_data[[year]] <- list()
  for (bp in bps) {
    quant_cols <- names(select_if(player_data[[year]][[bp]], is.numeric))
    agg_data[[year]][[bp]] <- player_data[[year]][[bp]][, c("Tm", quant_cols)] %>% group_by(Tm) %>% summarise_all("mean")
    agg_data[[year]][[bp]]$long_Tm <- mapvalues(agg_data[[year]][[bp]]$Tm,
                                                from=short_team_names,
                                                to=long_team_names)
    agg_data[[year]][[bp]] <- agg_data[[year]][[bp]][!(agg_data[[year]][[bp]]$Tm == "TOT"),]
  }
}

player_combo <- list()
for (year in years) {
  player_combo[[year]] <- merge(agg_data[[year]][[bps[1]]], agg_data[[year]][[bps[2]]], by="Tm")
}

# add response variable to player data
player_with_wins <- list()
for (year in 2018:2021) {
  player_with_wins[[year]] <- merge(player_combo[[year]], team_wins[[year+1]], by.x="long_Tm.x", by.y="Tm")
}
```

```{r}
# Explore Potential Predictors
par(mfrow=c(3,3))
player_with_wins_combined = rbind(player_with_wins[[2018]],
                                  player_with_wins[[2019]],
                                  player_with_wins[[2020]],
                                  player_with_wins[[2021]])
plot(W.L..y ~ Age.x, data=player_with_wins_combined,
     xlab="Batters' Average Age", ylab="Winning Percentage")
plot(W.L..y ~ Age.y, data=player_with_wins_combined,
     xlab="Pitchers' Average Age", ylab="Winning Percentage")
plot(W.L..y ~ BA, data=player_with_wins_combined,
     xlab="Batting Average", ylab="Winning Percentage")
plot(W.L..y ~ HR.x, data=player_with_wins_combined,
     xlab="Average Home Runs", ylab="Winning Percentage")
plot(W.L..y ~ OPS., data=player_with_wins_combined,
     xlab="Adjusted On Base Percentage Plus Slugging", ylab="Winning Percentage")
plot(W.L..y ~ ERA., data=player_with_wins_combined,
     xlab="Adjusted Earned Run Average", ylab="Winning Percentage")
plot(W.L..y ~ SO.W, data=player_with_wins_combined,
     xlab="Average Strikeout/Walk", ylab="Winning Percentage")
plot(W.L..y ~ HR9, data=player_with_wins_combined,
     xlab="Average Home Runs per Nine Innings", ylab="Winning Percentage")
plot(W.L..y ~ WHIP, data=player_with_wins_combined,
     xlab="Walks and Hits Per Inning Pitched", ylab="Winning Percentage")
```

```{r}
# Summary statistics for winpct
summary(player_with_wins_combined$W.L..y)

# Histogram for winpct
hist(player_with_wins_combined$W.L..y, main="Distribution of Winning Percentage",
     xlab="Winning Percentage")
```

```{r}
# Correlation matrix
cor(player_with_wins_combined[, c("W.L..y", "Age.x", "Age.y", "BA", "HR.x", "OPS", "ERA.", "SO.W", "HR9", "WHIP")])
cor(player_with_wins_combined[, c("W.L..y", "Age.x", "Age.y", "BA", "HR.x", "OPS", "ERA.", "SO.W", "HR9", "WHIP")])^2
```


```{r}
# Baseline Multiple Regression Model
baseline <- lm(W.L..y ~ Age.x + Age.y + BA + HR.x + 
                 OPS + ERA. + SO.W + HR9 + WHIP, data = player_with_wins_combined)
summary(baseline)
```


```{r}
# Asssess Linear Model Assumptions
plot(baseline, which=c(1,2))
```

